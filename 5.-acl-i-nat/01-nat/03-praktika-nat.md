# Практика

Чего от нас требует реальность?  
1\) Сеть управления не имеет доступа в интернет вообще  
2\) Хосты из сети ПТО имеют доступ только к профильным сайтам, например, Linkmeup.ru  
3\) Милым дамам из бухгалтерии нужно вырубить окно в мир клиент-банков.  
4\) ФЭО не выпускать никуда, за исключением финансового директора  
5\) В сети Other наш компьютер и компьютер админа — им дадим полный доступ в интернет. Всем остальным можно открывать по письменному запросу.  
6\) Не забудем про филиалы в Питере и в Кемерово. Для простоты настроим полный доступ для эникиев из этих подсетей.  
7\) С серверами отдельная песня. Для них мы настроим перенаправление портов. Всё, что нам нужно:  
а\) WEB-сервер должен быть доступен по 80-му порту  
б\) Почтовый сервер по 25-му и 110-му  
в\) Файловый сервер доступен из мира по FTP.  
8\) Компьютеры админа и наш должны быть доступны из Интернета по RDP. Вообще-то это неправильный путь — для удалённого подключения нужно использовать VPN-подключение и уже будучи в локальной сети использовать RDP, но это тема отдельной совсем другой статьи.

Сначала подготовим тестовую площадку:

Подключение к Интернету будет организовано через существующий линк, который предоставляет провайдер.  
Он уходит в сеть провайдера. Напоминаем, что всё в этом облаке — это абстрактная сеть, которая на деле может состоять из десятков маршрутизаторов и сотен коммутаторов. Но нам нужно нечто управляемое и предсказуемое, поэтому водружаем сюда ещё маршрутизатор. С одной стороны в него линк из коммутатора, с другой сервера в Интернете.

Сервера нам понадобятся следующие:  
1. Два клиент-банка для бухгалтеров \(sperbank.ru, mmm-bank.ru\)  
2. Linkmeup.ru для ПТОшников  
3. яндекс \(yandex.ru\)

![](http://img-fotki.yandex.ru/get/5301/83739833.1b/0_903a7_8e37d3ea_XL.jpg)

Для такого подключения мы поднимем ещё один влан на msk-arbat-gw1. Его номер, разумеется, согласуется с провайдером. Пусть это будет VLAN 6  
Предположим, провайдер предоставляет нам **подсеть 198.51.100.0/28**. Первые два адреса используются для организации линка \(198.51.100.1 и 198.51.100.2\), а оставшиеся мы используем, как пул для NAT’a. Впрочем, никто совершенно нам не мешает использовать и адрес 198.51.100.2 для пула. Так и сделаем: **пул: 198.51.100.2-198.51.100.14**  
Для простоты предположим, что публичные сервера у нас находятся в одной подсети:  
**192.0.2.0/24**.  
Как настроить линк и адреса вы вполне уже в курсе.  
Поскольку у нас только один маршрутизатор в сети провайдера, и все сети подключены непосредственно к нему, то необходимости настраивать маршрутизацию нету.  
А вот наш msk-arbat-gw1 должен знать куда отправлять пакеты в Интернет, поэтому нам нужен маршрут по умолчанию:

```text
msk-arbat-gw1(config)# ip route 0.0.0.0 0.0.0.0 198.51.100.1
```

Теперь по порядку

Во первых настроим пул адресов

```text
msk-arbat-gw1(config)# ip nat pool main_pool 198.51.100.2 198.51.100.14 netmask 255.255.255.240
```

Теперь собираем ACL:

```text
msk-arbat-gw1(config)# ip access-list extended nat-inet
```

## 1\) Сеть управления

не имеет доступа в интернет вообще  
Готово

## 2\) Хосты из сети ПТО

Имеют доступ только к профильным сайтам, например, Linkmeup.ru

```text
msk-arbat-gw1(config-ext-nacl)# permit tcp 172.16.3.0 0.0.0.255 host 192.0.2.2 eq 80
```

## 3\) Бухгалтерия

Даём доступ всем хостам на оба сервера

```text
msk-arbat-gw1(config-ext-nacl)# permit ip 172.16.5.0 0.0.0.255 host 192.0.2.3
msk-arbat-gw1(config-ext-nacl)# permit ip 172.16.5.0 0.0.0.255 host 192.0.2.4
```

## 4\) ФЭО

Даём разрешение только финансовому директору — это только один хост.

```text
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.4.123 any
```

## 5\) Other

Наши компьютеры с полным доступом

```text
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.6.61 any
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.6.66 any
```

## 6\) Филиалы в Санкт-Петербурге и Кемерово

Пусть адреса эникиев будут одинаковыми: 172.16.х.222

```text
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.16.222 any
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.17.222 any
msk-arbat-gw1(config-ext-nacl)# permit ip host 172.16.24.222 any
```

Вот так выглядит сейчас ACL полностью:

```text
ip access-list extended nat-inet
remark PTO
permit tcp 172.16.3.0 0.0.0.255 host 192.0.2.2 eq www
remark ACCOUNTING
permit ip 172.16.5.0 0.0.0.255 host 192.0.2.3
permit ip 172.16.5.0 0.0.0.255 host 192.0.2.4
remark FEO
permit ip host 172.16.4.123 any
remark IAM
permit ip host 172.16.6.61 any
remark ADMIN
permit ip host 172.16.6.66 any
remark SPB_VSL_ISLAND
permit ip host 172.16.16.222 any
remark SPB_OZERKI
permit ip host 172.16.17.222 any
remark KMR
permit ip host 172.16.24.222 any
```

Запускаем:

```text
msk-arbat-gw1(config)# ip nat inside source list nat-inet pool main_pool overload
```

Но счастье не будет полным без настройки интерфейсов:  
На внешнем интерфейсе нужно дать команду **ip nat outside**  
На внутреннем: **ip nat inside**

```text
msk-arbat-gw1(config)# int fa0/0.101
msk-arbat-gw1(config-subif)# ip nat inside 
msk-arbat-gw1(config)# int fa0/0.102
msk-arbat-gw1(config-subif)# ip nat inside 
msk-arbat-gw1(config)# int fa0/0.103
msk-arbat-gw1(config-subif)# ip nat inside 
msk-arbat-gw1(config)# int fa0/0.104
msk-arbat-gw1(config-subif)# ip nat inside 
msk-arbat-gw1(config)# int fa0/1.6
msk-arbat-gw1(config-subif)# ip nat outside
```

Это позволит маршрутизатору понять откуда ждать пакеты, которые нужно будет обработать и куда их потом слать.

Чтобы сервера в интернете были доступны по доменному имени, нам бы неплохо было обзавестись DNS-сервером в нашей сети:  
![](http://img-fotki.yandex.ru/get/5302/83739833.1b/0_903ae_478226c1_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5700/83739833.1b/0_90390_1f47a02a_XL.jpg)

Естественно его, нужно прописать на тех устройствах, с которых будем проверять доступ:  
![](http://img-fotki.yandex.ru/get/6314/83739833.1b/0_90391_e3335c6_XL.jpg)

Show must go on!

С компьютера админа доступно всё:  
![](http://img-fotki.yandex.ru/get/5800/83739833.1b/0_9039a_559bac1b_XL.jpg)

Из сети ПТО есть доступ только на сайт linkmeup.ru по 80-му порту \(HTTP\):  
![](http://img-fotki.yandex.ru/get/6114/83739833.1b/0_9039b_ab3c6e8a_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5300/83739833.1b/0_9039c_279b90db_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5301/83739833.1b/0_9039d_60a2f35c_XL.jpg)

В сети ФЭО в мир выходит только 4.123 \(финдиректор\)  
![](http://img-fotki.yandex.ru/get/5700/83739833.1b/0_9039e_15604104_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5301/83739833.1b/0_9039f_c03fd0d9_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5406/83739833.1b/0_903a0_7c1db041_XL.jpg)

В бухгалтерии работают только сайты клиент-банков. Но, поскольку разрешение дано полностью на протокол IP, то их можно и пинговать:  
![](http://img-fotki.yandex.ru/get/5700/83739833.1b/0_903a1_4f3df8c_XL.jpg)  
![](http://img-fotki.yandex.ru/get/5800/83739833.1b/0_903a2_aa08b4ed_XL.jpg)

## 7\) Cервера

Тут нам нужно настроить проброс портов, чтобы к ним можно было обращаться из Интернета:  
![](http://img-fotki.yandex.ru/get/6404/83739833.1c/0_92a25_e9eb12f9_XL.jpg)

## a\) Веб-сервер

```text
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.0.2 80 198.51.100.2 80
```

Сразу проверяем, например, мы можем это делать с тестового ПК c аресом 192.0.2.7.  
Сейчас ничего не заработает, потому что для сети серверов у нас не настроен интерфейс на msk-arbat-gw1:

```text
msk-arbat-gw1(config)# int fa0/0.3
msk-arbat-gw1(config-subif)# ip nat inside
```

А теперь:  
![](http://img-fotki.yandex.ru/get/5800/83739833.1b/0_903a3_e496e973_XL.jpg)

## б\) Файловый сервер

```text
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.0.3 20 198.51.100.3 20
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.0.3 21 198.51.100.3 21
```

Вот для этого в ACL Servers-out мы открывали также и 20-21-й порты для всех  
![](http://img-fotki.yandex.ru/get/5107/83739833.1b/0_903a4_58024cf3_XL.jpg)

## в\) Почтовый сервер

```text
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.0.4 25 198.51.100.4 25
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.0.4 110 198.51.100.4 110
```

Проверить также не сложно. Следуйте инструкциям:  
Сначала настраиваем почтовый сервер. Указываем домен и создаём двух пользователей.  
![](http://img-fotki.yandex.ru/get/6114/83739833.1b/0_90394_533d8271_XL.jpg)

Далее вносим домен в DNS. Этот шаг необязательный — можно к серверу обращаться и по IP, но почему бы и нет?  
![](http://img-fotki.yandex.ru/get/6114/83739833.1b/0_90395_5ef2108b_XL.jpg)

Настраиваем компьютер из нашей сети:  
![](http://img-fotki.yandex.ru/get/6314/83739833.1b/0_90396_893fd384_XL.jpg)

Из внешней:  
![](http://img-fotki.yandex.ru/get/6214/83739833.1b/0_90397_cd1326d0_XL.jpg)

Готовим письмо:  
![](http://img-fotki.yandex.ru/get/5107/83739833.1b/0_903af_2834243a_XL.jpg)

На локальном хосте нажимаем Receive:  
![](http://img-fotki.yandex.ru/get/6313/83739833.1b/0_90399_8b7287b6_XL.jpg)

## 8\) Доступ по RDP к компьютерам админа и нашему

```text
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.6.61 3389 198.51.100.10 3389
msk-arbat-gw1(config)# ip nat inside source static tcp 172.16.6.66 3389 198.51.100.10 3398
```


На этом первое знакомство с технологией NAT можно считать законченным.  
В качестве ещё одного ДЗ ответьте на вопрос, почему нет доступа в Интернет с компьютеров эникиев в Питере и в Кемерово. Ведь мы их добавили уже в список доступа.
