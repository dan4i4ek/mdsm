# Security Association

Прежде чем переходить дальше, разберемся с термином SA – Security Association. SA в общем смысле представляет собой набор параметров защищенного соединения \(например, алгоритм шифрования, ключ шифрования\), который может использоваться обеими сторонами соединения. У каждого соединения есть _ассоциированный_ с ним SA.  
Теперь по порядку, как создается защищенное соединение в IPSec:

* Для начала, участникам надо договорится, какие алгоритмы/механизмы защиты они будут использовать для своего защищенного соединения, поэтому в дело вступает IKE. Процесс состоит из двух фаз:
  * Фаза первая: участники аутентифицируют друг друга и договариваются о параметрах установки специального соединения \(тоже защищенного\), предназначенного только для обмена информацией о желаемых/поддерживаемых алгоритмах шифрования и прочих деталях будущего IPSec-туннеля. Параметры этого мини-туннеля \(правильно он называется ISAKMP Tunnel\) определяются политикой ISAKMP, в режим редактирования которой мы можем попасть из конфигурационного режима командой **crypto isakmp policy** _**номер**_**политики\_**. Если стороны пришли к соглашению, устанавливается ISAKMP туннель \(его наличие можно посмотреть командой **show crypto isakmp sa**\), по которому уже проходит вторая фаза IKE.
  * Фаза вторая: уже доверяющие друг другу участники договариваются о том, как строить основной туннель для данных. Они по очереди предлагают друг другу варианты, указанные в команде **crypto ipsec transform-set**, и, если приходят к согласию, поднимают основной туннель. Нужно сказать, что, после его установления, вспомогательный ISAKMP туннель никуда не пропадает – он используется для обновления SA основного. Дело в том, что ключи, выбираемые для шифрования информации в IPSec-туннеле, имеют некоторое “время жизни” \(может выражаться как в количестве байт, так и в секундах – что первое достигнет порогового значения\), по истечение которого должны быть заменены. Это как пароль, который вы меняете раз в час \(по умолчанию lifetime IPSec SA составляет 4608000 килобайт/3600 секунд\).
* Участники получили шифрованный туннель с параметрами, которые их всех устраивают, и направляют туда потоки данных, подлежащие шифрованию, т.е., подпадающие под указанный в crypto map аксесс-лист.
* Периодически, в соответствии с настроенным lifetime, обновляются ключи шифрования для основного туннеля: участники вновь связываются по ISAKMP-туннелю, проходят вторую фазу и устанавливают новые SA.

> Строго говоря, в этом процессе есть нулевой шаг: некий трафик должен попасть в соответствие аксесс-листу в крипто мапе. Только после этого будет происходить все остальное.

