# Теория

**Если вам интересно, давайте проследим, что происходит с пакетом по пути от PC1 до Internet.**

1\) Обычным образом пакет попадает на шлюз по умолчанию — _TARS\_2_

2\) _TARS\_2_ видит, что адрес назначения подпадает только под маршрут по умолчанию, передаёт пакет в интерфейс FE0/0 на _Linkmeup\_R3_.  
![](https://habrastorage.org/getpro/habr/post_images/215/82f/36f/21582f36f452ae7c8eb921d5b026f6eb.png)

В последний момент он замечает, что заголовок пакета полностью удовлетворяет списку доступа \(access-list 100\) и транслирует локальный адрес 172.16.1.2 в 100.0.1.2

3\) Пакет приходит в VRF TARS на _Linkmeup\_R3_, где снова подпадает под маршрут по умолчанию, который указывает на адрес 101.0.0.2 из глобальной таблицы маршрутизации. Уже из глобальной ТМ _Linkmeup\_R3_ знает, что 101.0.0.2 доступен через 1.1.1.1 и рекурсивно через 10.0.23.2. Причём пакету выдаётся метка 16. То есть после _Linkmeup\_R3_ пакет уже пойдёт по MPLS LSP.  
![](https://habrastorage.org/getpro/habr/post_images/fd1/2e6/133/fd12e6133bedf0fd094acdb0e06663b5.png)

![](https://habrastorage.org/getpro/habr/post_images/7b6/4db/5be/7b64db5be499ee81a3c9b3d0f72d8f8c.png)  
_Пакет между Linkmeup\_R3 и Provier\_R2_

Заметьте, что метки VPN здесь нет — пакет перекочевал из VPN в публичную сеть.

4\) На _Linkmeup\_R2_ с пакета снимается транспортная метка MPLS \(происходит [PHP](http://lookmeup.linkmeup.ru/#term487)\) и на _Linkmeup\_R1_ уже передаётся чистый IP-пакет.

5\) Этот чистый IP-пакет уходит с _Linkmeup\_R1_ в _Internet_ \(BGP сообщил маршрут до сети 101.0.0.0/20\)

6\) _Internet_ знает маршрут до 100.0.0.0/23 так же по BGP и передаёт пакет обратно.

7\) _Linkmeup\_R1_ знает, что адресат находится за 3.3.3.3 — помните, мы объявляли эту сеть в BGP?  
Соответственно, по MPLS он доходит до _Linkmeup\_R3_.  
![](https://habrastorage.org/getpro/habr/post_images/2f9/4b2/d31/2f94b2d31dca5e8904bcb8876c4fafef.png)

8\) Сеть 100.0.1.0/30 находится в VRF TARS, но мы ведь прописывали её статически в интерфейс FE1/0. Так что пакет передаётся благополучно на интерфейс.

9\) Ну а дальше обратная трансляция на _TARS\_2_ и последняя миля до родного дома.
