# MBGP

Сейчас ответим на два вопроса: как маршруты передаются в провайдерской сети от одного PE к другому и как обеспечивается изоляция.

В общем-то до сих пор не придумано ничего лучше для передачи маршрутов на удалённые узлы, чем BGP: и гибкость передачи самих маршрутов, и масса инструментов по влиянию на выбор маршрута, и политики получения и передачи маршрутов, и Community, сильно упрощающие групповые действия над маршрутами.

Если вдруг вы [забыли](https://linkmeup.ru/blog/65.html), тот вот обычное сообщение BGP Update:  
![](http://img-fotki.yandex.ru/get/6425/83739833.28/0_b9242_86b25cb8_XXXL.png)

В секции [NLRI](http://lookmeup.linkmeup.ru/#term541) оно переносит сам префикс. А в других секциях масса его параметров.

К его помощи и прибегают при реализации MPLS L3VPN. Поэтому его второе имя MPLS BGP VPN.

Вы ведь помните, как это происходит? BGP устанавливает сессию со своими соседями через TCP на порт 179. Это позволяет в качестве соседей выбирать не напрямую подключенный маршрутизатор, а те, что находятся в нескольких хопах. Так и работает IBGP, где в пределах магистральной сети предполагается связь «каждый с каждым».  
Когда несколько маршрутов, ведущих в одну сеть, приходят на узел, BGP просто выбирает из них лучший и инсталлирует его в таблицу маршрутизации.

То есть в целом нам ничего не стоит передать маршрут VPN через сеть на другой её конец.  
BGP должен взять маршруты из VRF на одном узле, доставить их на другой и там экспортировать в правильный VRF.

Вот только загвоздка в том, что BGP изначально ориентирован на работу с публичными адресами, которые предполагаются уникальными во всём мире. А клиенты-негодяи обычно хотят передавать маршруты в частные сети \([RFC1918](https://tools.ietf.org/html/rfc1918)\) и, как назло, они запросто могут пересекаться как с сетями других VPN, так и со внутренним адресным пространством самого провайдера.

То есть, если, например, R3 получит два маршрута в сеть 10.10.10.10/32 \(один от TARS's Robotics, другой от C3PO Electronic\), он выберет только один — с лучшими показателями, как предписывает стандарт — он думает, что это два маршрута в одну и ту же сеть.

![](https://img-fotki.yandex.ru/get/40777/83739833.55/0_10e8a9_af11c402_orig.png)

Естественно, нам это не подходит. Нужно, чтобы выполнялось два условия:  
1\) Маршруты разных VPN были уникальными и не смешивались при передаче между PE.  
2\) Маршруты в конечной точке должны быть переданы правильному VRF.

Этим проблемам было найдено элегантное решение. Начнём с п.1 — уникальность маршрутов.

В нашем примере 10.10.10.10/32 от TARS's Robotics должен чем-то отличаться от 10.10.10.10/32 от C3PO Electronic.  
BGP невероятно гибкий протокол \(не зря ведь он стал единственным протоколом внешнего шлюза\). Он легко масштабируется и с помощью так называемых [Address Family](http://lookmeup.linkmeup.ru/#term569) он может передавать маршруты не только IPv4, но и IPv6 и IPX \(да только кому он нужен\). Хочешь передать что-то новое — заведи свою Address Family,  
И создал IETF новый Address Family. И дал он имя ему VPNv4 \(или VPN-IPv4\).
