# 4. STP

```text
*I think that I shall never see
A graph more lovely than a tree.
A tree whose crucial propertyеу
Is loop-free connectivity.
A tree that must be sure to span
So packets can reach every LAN.
First, the root must be selected.
By ID, it is elected.
Least-cost paths from root are traced.
In the tree, these paths are placed.
A mesh is made by folks like me,
Then bridges find a spanning tree.*
```

* Radia Joy Perlman

Однажды, когда вы — единственный сетевой админ фирмы “Лифт ми Ап” — отпросились на полдня раньше, вдруг упала связь с серверами, и директора не получили несколько важных писем. После короткой, но ощутимой взбучки вы идёте разбираться, в чём дело, а оказалось, по чьей-то неосторожности выпал из разъёма единственный кабель, ведущий к коммутатору в серверной. Небольшая проблема, которую вы могли исправить за две минуты, и даже вообще избежать, существенно сказалась на вашем доходе в этом месяце и возможностях роста.

Итак, сегодня обсуждаем:

* проблему широковещательного шторма
* работу и настройку протокола STP и его модификаций \(RSTP, MSTP, PVST, PVST+\)
* технологию агрегации интерфейсов и перераспределения нагрузки между ними
* некоторые вопросы стабильности и безопасности
* как изменить схему существующей сети, чтобы всем было хорошо

{% embed url="https://youtu.be/qktkRnIamqE" caption="Традиционное Видео" %}

Оборудование, работающее на втором уровне модели OSI \(коммутатор, он же свич\), должно выполнять 3 функции: запоминание адресов, перенаправление \(коммутация\) пакетов, защита от петель в сети. Разберем по пунктам каждую функцию.

## Запоминание адресов и перенаправление пакетов

Как мы уже говорили [ранее,](https://linkmeup.gitbook.io/sdsm/2.-switching) у каждого свича есть таблица сопоставления MAC-адресов и портов \(aka CAM-table — Content Addressable Memory Table\). Когда устройство, подключенное к свичу, посылает кадр в сеть, свич смотрит MAC-адрес отправителя и порт, откуда получен кадр, и добавляет эту информацию в свою таблицу. Далее он должен передать кадр получателю, адрес которого указан в кадре. По идее, информацию о порте, куда нужно отправить кадр, он берёт из этой же CAM-таблицы. Но, предположим, что свич только что включили \(таблица пуста\), и он понятия не имеет, в какой из его портов подключен получатель. В этом случае он отправляет полученный кадр во все свои порты, кроме того, откуда он был принят. Все конечные устройства, получив этот кадр, смотрят MAC-адрес получателя, и, если он адресован не им, отбрасывают его. Устройство-получатель отвечает отправителю, а в поле отправителя ставит свой адрес, и вот свич уже знает, что такой-то адрес находится на таком-то порту \(вносит запись в таблицу\), и в следующий раз уже будет переправлять кадры, адресованные этому устройству, только в этот порт. Чтобы посмотреть содержимое CAM-таблицы, используется команда **show mac address-table**. Однажды попав в таблицу, информация не остаётся там пожизненно, содержимое постоянно обновляется и если к определенному mac-адресу не обращались 300 секунд \(по умолчанию\), запись о нем удаляется. Тут всё должно быть понятно. Но зачем _защита от петель_? И что это вообще такое?

